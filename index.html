<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Алхимия: ингредиенты/рецепты + JSON + картинки из /img</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    body { margin: 0; background: #0b0c10; color: #e8e8e8; }
    header { padding: 14px 18px; border-bottom: 1px solid #2b2e3a; background: #0f1117; }
    header h1 { margin: 0; font-size: 16px; }
    header .row { margin-top: 10px; display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    main { display: grid; grid-template-columns: 1.2fr 0.9fr 0.9fr; gap: 12px; padding: 12px; }
    .panel { background: #111522; border: 1px solid #2b2e3a; border-radius: 12px; overflow: hidden; }
    .panel h2 { margin: 0; padding: 12px; font-size: 13px; border-bottom: 1px solid #2b2e3a; background: #0f1320; }
    .panel .body { padding: 12px; }
    .row { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
    input, select, button, textarea {
      background: #0f1320; color: #e8e8e8; border: 1px solid #2b2e3a; border-radius: 10px;
      padding: 8px 10px;
    }
    textarea { width:100%; min-height:70px; resize:vertical; }
    button { cursor: pointer; }
    button:hover { border-color: #5b63ff; }
    .list { display: grid; gap: 8px; }
    .card {
      border: 1px solid #2b2e3a; border-radius: 12px; padding: 10px;
      background: #0f1320;
    }
    .card .top { display: flex; justify-content: space-between; gap: 10px; }
    .tag { font-size: 12px; opacity: 0.9; border: 1px solid #2b2e3a; padding: 2px 8px; border-radius: 999px; }
    .small { font-size: 12px; opacity: 0.85; line-height: 1.3; }
    .pillbar { display: flex; gap: 6px; flex-wrap: wrap; margin-top: 6px; }
    .pill { font-size: 12px; border: 1px solid #2b2e3a; padding: 2px 8px; border-radius: 999px; background: #0b0f1d; }
    .zone {
      min-height: 90px;
      border: 1px dashed #2b2e3a; border-radius: 12px;
      padding: 10px; background: rgba(255,255,255,0.02);
    }
    .zone.dragover { border-color: #5b63ff; }
    .item {
      display: inline-flex; align-items: center; gap: 6px;
      border: 1px solid #2b2e3a; border-radius: 999px;
      padding: 6px 10px; margin: 4px 6px 0 0;
      background: #0b0f1d;
    }
    .item button { padding: 2px 8px; border-radius: 999px; }
    .result { font-size: 14px; line-height: 1.35; }
    .muted { opacity: 0.8; }
    .img {
      width: 44px; height: 44px; object-fit: cover;
      border: 1px solid #2b2e3a; border-radius: 10px;
      background:#0b0f1d;
    }
    .imgBig {
      width: 120px; height: 120px; object-fit: cover;
      border: 1px solid #2b2e3a; border-radius: 14px;
      background:#0b0f1d;
    }
    .split { display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    .danger { border-color:#ff5b5b !important; }
    .ok { border-color:#5bff86 !important; }
    footer { padding: 12px 18px; border-top: 1px solid #2b2e3a; background: #0f1117; font-size: 12px; opacity: 0.85; }
    @media (max-width: 980px) { main { grid-template-columns: 1fr; } }
  </style>
</head>

<body>
<header>
  <h1>Алхимия • CRUD • экспорт/импорт JSON • картинки из <code>/img</code> • описание и стоимость</h1>

  <div class="row">
    <button id="exportJson">Экспорт JSON</button>
    <label class="small">Импорт JSON:
      <input id="importJson" type="file" accept="application/json" style="padding:6px 10px; margin-left:6px;">
    </label>
    <button id="resetAll" class="danger">Сбросить всё</button>
    <span class="small muted">Картинки: указывай имя файла, например <code>moss.png</code> → подтянется <code>./img/moss.png</code></span>
  </div>
</header>

<main>
  <section class="panel">
    <h2>Ингредиенты</h2>
    <div class="body">
      <div class="row" style="margin-bottom:10px">
        <input id="search" placeholder="Поиск по названию/эффекту/описанию…" style="flex:1" />
        <select id="rarityFilter">
          <option value="">Редкость: любая</option>
          <option value="common">Обычный</option>
          <option value="uncommon">Необычный</option>
          <option value="rare">Редкий</option>
          <option value="very_rare">Очень редкий</option>
        </select>
        <button id="openIngredientEditor">+ Ингредиент</button>
      </div>

      <div class="small muted" style="margin-bottom:10px">
        Клик “В мешочек”. Drag: перетащить в мешочек/реторту. Есть редактирование/удаление.
      </div>

      <div id="ingredients" class="list"></div>
    </div>
  </section>

  <section class="panel">
    <h2>Мешочек компонентов</h2>
    <div class="body">
      <div id="bagZone" class="zone" data-zone="bag">
        <div class="small muted">Перетащи сюда ингредиенты или кликай по списку.</div>
        <div id="bagItems"></div>
      </div>
      <div class="row" style="margin-top:10px">
        <button id="bagToRetort">→ В реторту</button>
        <button id="clearBag">Очистить мешочек</button>
      </div>

      <hr style="border:0;border-top:1px solid #2b2e3a;margin:12px 0">
      <div class="row" style="margin-bottom:8px">
        <strong class="small">Рецепты</strong>
        <button id="openRecipeEditor">+ Рецепт</button>
      </div>
      <div class="small muted" style="margin-bottom:8px">
        Рецепты имеют приоритет над “скайрим-пересечением”.
      </div>
      <div id="recipes" class="list"></div>
    </div>
  </section>

  <section class="panel">
    <h2>Алхимическая реторта</h2>
    <div class="body">
      <div class="row" style="margin-bottom:10px">
        <label class="small">Лаба:</label>
        <select id="labTier">
          <option value="t0">Tier 0 (полевой набор)</option>
          <option value="t1" selected>Tier 1 (домашняя лаба)</option>
          <option value="t2">Tier 2 (лаба + Ядро)</option>
        </select>

        <label class="small">Эффектов:</label>
        <select id="maxEffects">
          <option value="1" selected>1</option>
          <option value="2">2 (если есть 2 пересечения)</option>
        </select>
      </div>

      <div id="retortZone" class="zone" data-zone="retort">
        <div class="small muted">Перетащи ингредиенты сюда или нажми “→ В реторту”.</div>
        <div id="retortItems"></div>
      </div>

      <div class="row" style="margin-top:10px">
        <button id="brew">Сварить</button>
        <button id="clearRetort">Очистить реторту</button>
      </div>

      <div class="panel" style="margin-top:12px">
        <h2>Результат</h2>
        <div class="body result" id="result">
          <div class="muted">Добавь 2–3 ингредиента в реторту и нажми “Сварить”.</div>
        </div>
      </div>
    </div>
  </section>
</main>

<footer>
  Хранение: ингредиенты/рецепты в localStorage. Экспорт JSON — бэкап. Картинки — файловые, лежат в /img.
</footer>

<!-- Ingredient dialog -->
<dialog id="ingredientDialog" style="max-width:900px; width: min(900px, 92vw); background:#0f1117; color:#e8e8e8; border:1px solid #2b2e3a; border-radius:14px; padding:0">
  <form method="dialog" style="margin:0">
    <div style="padding:12px 14px; border-bottom:1px solid #2b2e3a; display:flex; justify-content:space-between; align-items:center;">
      <strong id="ingredientDialogTitle">Ингредиент</strong>
      <button value="cancel">Закрыть</button>
    </div>

    <div style="padding:12px 14px" class="split">
      <div>
        <div class="row" style="margin-bottom:8px">
          <input id="ing_id" placeholder="id (латиница, без пробелов)" style="flex:1" />
          <select id="ing_rarity">
            <option value="common">Обычный</option>
            <option value="uncommon">Необычный</option>
            <option value="rare">Редкий</option>
            <option value="very_rare">Очень редкий</option>
          </select>
        </div>

        <input id="ing_name" placeholder="Название" style="width:100%; margin-bottom:8px" />

        <div class="row" style="margin-bottom:8px">
          <input id="ing_cost" type="number" min="0" step="1" placeholder="Стоимость (зм)" style="width:200px" />
          <input id="ing_image_file" placeholder="Картинка (например moss.png)" style="flex:1" />
        </div>

        <textarea id="ing_desc" placeholder="Описание ингредиента (лоре/применение/заметки)"></textarea>

        <div class="small muted" style="margin:10px 0 6px">Эффекты (тэги): выбери 1–6 (обычно 4).</div>
        <div id="ing_effects" class="row" style="margin-bottom:10px"></div>

        <div class="small muted">
          Примечание: поле “Картинка” — это имя файла в <code>/img</code>. Пусто = без картинки.
        </div>
      </div>

      <div>
        <div class="small muted" style="margin-bottom:6px">Превью</div>
        <img id="ing_preview" class="imgBig" alt="preview" style="display:none" />
        <div class="small muted" style="margin-top:10px">
          Удаление ингредиента уберёт его из мешочка/реторты и из рецептов (где он используется).
        </div>
      </div>
    </div>

    <div style="padding:12px 14px; border-top:1px solid #2b2e3a; display:flex; gap:8px; justify-content:flex-end;">
      <button id="ing_delete" type="button" class="danger">Удалить</button>
      <button id="ing_save" type="button" class="ok">Сохранить</button>
    </div>
  </form>
</dialog>

<!-- Recipe dialog -->
<dialog id="recipeDialog" style="max-width:920px; width: min(920px, 92vw); background:#0f1117; color:#e8e8e8; border:1px solid #2b2e3a; border-radius:14px; padding:0">
  <form method="dialog" style="margin:0">
    <div style="padding:12px 14px; border-bottom:1px solid #2b2e3a; display:flex; justify-content:space-between; align-items:center;">
      <strong id="recipeDialogTitle">Рецепт</strong>
      <button value="cancel">Закрыть</button>
    </div>

    <div style="padding:12px 14px" class="split">
      <div>
        <div class="row" style="margin-bottom:8px">
          <input id="rec_id" placeholder="id рецепта" style="flex:1" />
          <select id="rec_kind">
            <option value="ingredients" selected>По ингредиентам (точный список)</option>
            <option value="effects">По эффектам (тэги должны совпасть)</option>
          </select>
        </div>

        <input id="rec_name" placeholder="Название результата (зелья/яда)" style="width:100%; margin-bottom:8px" />
        <textarea id="rec_desc" placeholder="Описание эффекта (текст для результата)"></textarea>

        <div class="row" style="margin-top:8px">
          <label class="small">Сила (влияет на DC):</label>
          <select id="rec_power">
            <option value="0">Малая (+0)</option>
            <option value="1" selected>Средняя (+2)</option>
            <option value="2">Сильная (+4)</option>
          </select>
          <label class="small">Базовый DC (опц.):</label>
          <input id="rec_base_dc" type="number" min="0" placeholder="пусто = авто" style="width:140px" />
        </div>

        <div class="row" style="margin-top:8px">
          <input id="rec_image_file" placeholder="Картинка результата (например potion_heal.png)" style="flex:1" />
        </div>

        <hr style="border:0;border-top:1px solid #2b2e3a;margin:12px 0">
        <div class="small muted" style="margin-bottom:6px">Условия рецепта:</div>
        <div id="rec_match_area"></div>
      </div>

      <div>
        <div class="small muted" style="margin-bottom:6px">Превью результата</div>
        <img id="rec_preview" class="imgBig" alt="preview" style="display:none" />
        <div class="small muted" style="margin-top:10px">
          При варке: 1) точный рецепт по ингредиентам, 2) рецепт по эффектам, 3) Skyrim-пересечение.
        </div>
      </div>
    </div>

    <div style="padding:12px 14px; border-top:1px solid #2b2e3a; display:flex; gap:8px; justify-content:flex-end;">
      <button id="rec_delete" type="button" class="danger">Удалить</button>
      <button id="rec_save" type="button" class="ok">Сохранить</button>
    </div>
  </form>
</dialog>

<script>
/* ========= Config ========= */
const IMG_BASE = "./img/"; // откуда тянуть картинки

const STORE_KEY = "alchemy_v3_store";

const EFFECTS = {
  heal_minor:    { name: "Лечение (малое)", power: 1, desc: "Восстанови 2d4+2 HP." },
  resist_acid:   { name: "Сопротивление кислоте", power: 1, desc: "Сопротивление кислоте на 10 минут." },
  resist_cold:   { name: "Сопротивление холоду", power: 1, desc: "Сопротивление холоду на 10 минут." },
  resist_fire:   { name: "Сопротивление огню", power: 1, desc: "Сопротивление огню на 10 минут." },
  antitoxin:     { name: "Антитоксин", power: 1, desc: "Преимущество на спасброски от яда на 1 час." },
  poison_basic:  { name: "Яд (базовый)", power: 1, desc: "Оружейный яд: КС 12 Тел, 2d6 яда (половина при успехе)." },
  slow:          { name: "Замедление", power: 1, desc: "КС 12 Тел: скорость −10 фт на 1 минуту (повтор в конце хода)." },
  sleepiness:    { name: "Сонливость", power: 1, desc: "КС 12 Тел: без реакций 1 минуту (повтор в конце хода)." },
  darkvision:    { name: "Тёмное зрение", power: 1, desc: "Тёмное зрение 60 фт на 1 час (если нет)." },
  waterbreath:   { name: "Дыхание под водой", power: 2, desc: "Дышать под водой 1 час." },
  speed:         { name: "Проворство", power: 1, desc: "Скорость +10 фт на 10 минут." },
  clarity:       { name: "Ясность", power: 1, desc: "Преимущество на Внимательность/Расследование 1 час." }
};

const RARITY = {
  common:    { name: "Обычный",      dc: 0 },
  uncommon:  { name: "Необычный",    dc: 1 },
  rare:      { name: "Редкий",       dc: 2 },
  very_rare: { name: "Очень редкий", dc: 3 }
};

/* ===== Defaults (тут добавили: desc, cost, imageFile) ===== */
const DEFAULT_INGREDIENTS = [
  { id:"moss", name:"Кислая моховина", rarity:"common", effects:["resist_acid","antitoxin","poison_basic","slow"], desc:"Ковёр мха с резким кислым запахом. Хорош для нейтрализации токсинов и разъедающих настоев.", cost:5, imageFile:"moss.png" },
  { id:"saltwort", name:"Солянка болотная", rarity:"common", effects:["antitoxin","heal_minor","clarity","sleepiness"], desc:"Солёная трава, которую сушат на нитях. Часто входит в домашние микстуры.", cost:3, imageFile:"saltwort.png" },
  { id:"emberleaf", name:"Угольный лист", rarity:"uncommon", effects:["resist_fire","speed","clarity","poison_basic"], desc:"Лист с прожилками как тлеющие угли. Стабилизирует горячие экстракты.", cost:15, imageFile:"emberleaf.png" },
  { id:"frostcap", name:"Морозный гриб", rarity:"uncommon", effects:["resist_cold","darkvision","sleepiness","slow"], desc:"Хрупкий гриб, который “потеет” инеем.", cost:12, imageFile:"frostcap.png" },
];

const DEFAULT_RECIPES = [
  {
    id:"heal_classic",
    kind:"effects",
    name:"Зелье лечения (домашнее)",
    desc:"• Восстанови 2d4+2 HP.\n• На провале 1–4: 2d4 HP.\n• На нат.20: +1 доза или +25% (на вкус мастера).",
    power:1,
    baseDc:null,
    matchIngredients:null,
    matchEffects:["heal_minor"],
    imageFile:"potion_heal.png"
  }
];

/* ========= State ========= */
const state = {
  store: loadStore(),
  bag: loadLocal("bag", []),
  retort: loadLocal("retort", []),
  editingIngredientId: null,
  editingRecipeId: null
};

function loadStore(){
  try {
    const raw = localStorage.getItem(STORE_KEY);
    if (!raw) return { ingredients: structuredClone(DEFAULT_INGREDIENTS), recipes: structuredClone(DEFAULT_RECIPES) };
    const parsed = JSON.parse(raw);
    if (!parsed.ingredients || !parsed.recipes) throw new Error("bad store");
    return parsed;
  } catch {
    return { ingredients: structuredClone(DEFAULT_INGREDIENTS), recipes: structuredClone(DEFAULT_RECIPES) };
  }
}
function saveStore(){ localStorage.setItem(STORE_KEY, JSON.stringify(state.store)); }
function loadLocal(k, fallback){
  try { return JSON.parse(localStorage.getItem("alchemy_"+k)) ?? fallback; } catch { return fallback; }
}
function saveLocal(k, v){ localStorage.setItem("alchemy_"+k, JSON.stringify(v)); }

/* ========= DOM ========= */
const elIngredients = document.getElementById("ingredients");
const elRecipes = document.getElementById("recipes");
const elBagItems = document.getElementById("bagItems");
const elRetortItems = document.getElementById("retortItems");
const elSearch = document.getElementById("search");
const elRarityFilter = document.getElementById("rarityFilter");
const elResult = document.getElementById("result");

renderAll();

/* ========= Top buttons ========= */
document.getElementById("resetAll").onclick = () => {
  if (!confirm("Точно сбросить всё?")) return;
  state.store = { ingredients: structuredClone(DEFAULT_INGREDIENTS), recipes: structuredClone(DEFAULT_RECIPES) };
  state.bag = [];
  state.retort = [];
  saveStore();
  saveLocal("bag", state.bag);
  saveLocal("retort", state.retort);
  renderAll();
  showResult(null);
};

document.getElementById("exportJson").onclick = () => {
  const payload = { version: 3, exportedAt: new Date().toISOString(), store: state.store };
  const blob = new Blob([JSON.stringify(payload, null, 2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "alchemy_data.json";
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
};

document.getElementById("importJson").onchange = async (ev) => {
  const file = ev.target.files?.[0];
  if (!file) return;
  try {
    const text = await file.text();
    const payload = JSON.parse(text);
    const imported = payload.store ?? payload;
    if (!imported.ingredients || !imported.recipes) throw new Error("В JSON нет ingredients/recipes");
    state.store = {
      ingredients: Array.isArray(imported.ingredients) ? imported.ingredients : [],
      recipes: Array.isArray(imported.recipes) ? imported.recipes : []
    };
    saveStore();
    renderAll();
    alert("Импорт выполнен.");
  } catch (e) {
    alert("Ошибка импорта: " + (e?.message ?? e));
  } finally {
    ev.target.value = "";
  }
};

/* ========= Bag / Retort ========= */
document.getElementById("clearBag").onclick = () => { state.bag=[]; saveLocal("bag", state.bag); renderAll(); };
document.getElementById("clearRetort").onclick = () => { state.retort=[]; saveLocal("retort", state.retort); renderAll(); showResult(null); };

document.getElementById("bagToRetort").onclick = () => {
  const canTake = Math.max(0, 3 - state.retort.length);
  const moved = state.bag.splice(0, canTake);
  state.retort.push(...moved);
  saveLocal("bag", state.bag); saveLocal("retort", state.retort);
  renderAll();
};

document.getElementById("brew").onclick = () => {
  const labTier = document.getElementById("labTier").value;
  const maxEffects = Number(document.getElementById("maxEffects").value);

  const selected = state.retort
    .map(id => state.store.ingredients.find(x => x.id === id))
    .filter(Boolean);

  if (selected.length < 2) return showResult({ error:"Нужно минимум 2 ингредиента в реторте." });
  if (selected.length > 3) return showResult({ error:"Для одной варки используй 2–3 ингредиента (сейчас больше 3)." });

  const brew = computeBrew(selected, { labTier, maxEffects });
  showResult(brew);
};

/* ========= Search ========= */
elSearch.oninput = renderIngredients;
elRarityFilter.onchange = renderIngredients;

/* ========= Ingredient editor ========= */
const ingredientDialog = document.getElementById("ingredientDialog");
document.getElementById("openIngredientEditor").onclick = () => openIngredientEditor(null);

const ing_id = document.getElementById("ing_id");
const ing_name = document.getElementById("ing_name");
const ing_rarity = document.getElementById("ing_rarity");
const ing_cost = document.getElementById("ing_cost");
const ing_image_file = document.getElementById("ing_image_file");
const ing_desc = document.getElementById("ing_desc");
const ing_effects = document.getElementById("ing_effects");
const ing_preview = document.getElementById("ing_preview");
const ing_save = document.getElementById("ing_save");
const ing_delete = document.getElementById("ing_delete");
const ingredientDialogTitle = document.getElementById("ingredientDialogTitle");

function openIngredientEditor(id){
  state.editingIngredientId = id;
  const existing = id ? state.store.ingredients.find(i => i.id === id) : null;

  ingredientDialogTitle.textContent = existing ? `Ингредиент: ${existing.name}` : "Новый ингредиент";
  ing_id.value = existing?.id ?? "";
  ing_id.disabled = !!existing;
  ing_name.value = existing?.name ?? "";
  ing_rarity.value = existing?.rarity ?? "common";
  ing_cost.value = (existing?.cost ?? "") === 0 ? "0" : (existing?.cost ?? "");
  ing_image_file.value = existing?.imageFile ?? "";
  ing_desc.value = existing?.desc ?? "";

  updatePreview(ing_preview, ing_image_file.value);

  ing_effects.innerHTML = "";
  const selected = new Set(existing?.effects ?? []);
  for (const key of Object.keys(EFFECTS)) {
    const wrap = document.createElement("label");
    wrap.className = "pill";
    wrap.style.cursor = "pointer";
    const cb = document.createElement("input");
    cb.type = "checkbox";
    cb.checked = selected.has(key);
    cb.dataset.key = key;
    cb.style.marginRight = "6px";
    wrap.prepend(cb);
    wrap.append(document.createTextNode(EFFECTS[key].name));
    ing_effects.appendChild(wrap);
  }

  ing_delete.style.display = existing ? "inline-block" : "none";
  ingredientDialog.showModal();
}

ing_image_file.oninput = () => updatePreview(ing_preview, ing_image_file.value);

ing_save.onclick = () => {
  const id = ing_id.value.trim();
  const name = ing_name.value.trim();
  if (!id || !/^[a-z0-9_\-]+$/i.test(id)) return alert("id обязателен и должен быть латиницей/цифрами/ _ - без пробелов.");
  if (!name) return alert("Название обязательно.");

  const effects = [...ing_effects.querySelectorAll("input[type=checkbox]")]
    .filter(cb => cb.checked)
    .map(cb => cb.dataset.key);

  if (effects.length === 0) return alert("Нужно выбрать хотя бы 1 эффект.");
  if (effects.length > 6) return alert("Слишком много эффектов. Держи 1–6 (обычно 4).");

  const costRaw = ing_cost.value.trim();
  const cost = costRaw === "" ? null : Number(costRaw);
  if (cost !== null && (!Number.isFinite(cost) || cost < 0)) return alert("Стоимость должна быть числом >= 0 или пустой.");

  const imageFile = ing_image_file.value.trim() || null;

  const obj = {
    id,
    name,
    rarity: ing_rarity.value,
    effects,
    desc: ing_desc.value.trim(),
    cost,
    imageFile
  };

  const exists = state.store.ingredients.some(x => x.id === id);
  state.store.ingredients = exists
    ? state.store.ingredients.map(x => x.id === id ? obj : x)
    : [...state.store.ingredients, obj];

  saveStore();
  renderAll();
  ingredientDialog.close();
};

ing_delete.onclick = () => {
  const id = state.editingIngredientId;
  if (!id) return;
  if (!confirm("Удалить ингредиент?")) return;

  state.store.ingredients = state.store.ingredients.filter(i => i.id !== id);

  state.bag = state.bag.filter(x => x !== id);
  state.retort = state.retort.filter(x => x !== id);
  saveLocal("bag", state.bag);
  saveLocal("retort", state.retort);

  state.store.recipes = state.store.recipes.map(r => {
    if (r.kind === "ingredients" && Array.isArray(r.matchIngredients)) {
      return { ...r, matchIngredients: r.matchIngredients.filter(x => x !== id) };
    }
    return r;
  });

  saveStore();
  renderAll();
  ingredientDialog.close();
};

/* ========= Recipe editor ========= */
const recipeDialog = document.getElementById("recipeDialog");
document.getElementById("openRecipeEditor").onclick = () => openRecipeEditor(null);

const rec_id = document.getElementById("rec_id");
const rec_kind = document.getElementById("rec_kind");
const rec_name = document.getElementById("rec_name");
const rec_desc = document.getElementById("rec_desc");
const rec_power = document.getElementById("rec_power");
const rec_base_dc = document.getElementById("rec_base_dc");
const rec_image_file = document.getElementById("rec_image_file");
const rec_match_area = document.getElementById("rec_match_area");
const rec_preview = document.getElementById("rec_preview");
const rec_save = document.getElementById("rec_save");
const rec_delete = document.getElementById("rec_delete");
const recipeDialogTitle = document.getElementById("recipeDialogTitle");

function openRecipeEditor(id){
  state.editingRecipeId = id;
  const existing = id ? state.store.recipes.find(r => r.id === id) : null;

  recipeDialogTitle.textContent = existing ? `Рецепт: ${existing.name}` : "Новый рецепт";
  rec_id.value = existing?.id ?? "";
  rec_id.disabled = !!existing;
  rec_kind.value = existing?.kind ?? "ingredients";
  rec_name.value = existing?.name ?? "";
  rec_desc.value = existing?.desc ?? "";
  rec_power.value = String(existing?.power ?? 1);
  rec_base_dc.value = (existing?.baseDc ?? "") === null ? "" : (existing?.baseDc ?? "");
  rec_image_file.value = existing?.imageFile ?? "";
  updatePreview(rec_preview, rec_image_file.value);

  buildRecipeMatchUI(existing);
  rec_delete.style.display = existing ? "inline-block" : "none";
  recipeDialog.showModal();
}

rec_kind.onchange = () => buildRecipeMatchUI(null, true);
rec_image_file.oninput = () => updatePreview(rec_preview, rec_image_file.value);

function buildRecipeMatchUI(existing){
  const kind = rec_kind.value;
  rec_match_area.innerHTML = "";

  if (kind === "ingredients") {
    const selected = new Set(existing?.matchIngredients ?? []);
    const hint = document.createElement("div");
    hint.className = "small muted";
    hint.style.marginBottom = "6px";
    hint.textContent = "Выбери 2–3 ингредиента, которые должны быть в реторте (точный матч по набору).";
    rec_match_area.appendChild(hint);

    for (const ing of state.store.ingredients) {
      const row = document.createElement("label");
      row.className = "card";
      row.style.cursor = "pointer";
      row.style.display = "flex";
      row.style.gap = "10px";
      row.style.alignItems = "center";

      const cb = document.createElement("input");
      cb.type = "checkbox";
      cb.checked = selected.has(ing.id);
      cb.dataset.id = ing.id;

      const imgUrl = imgUrlOf(ing.imageFile);
      if (imgUrl) {
        const img = document.createElement("img");
        img.className = "img";
        img.alt = ing.name;
        img.src = imgUrl;
        row.appendChild(cb);
        row.appendChild(img);
      } else {
        row.appendChild(cb);
      }

      const info = document.createElement("div");
      const costTxt = (ing.cost === null || ing.cost === undefined || ing.cost === "") ? "—" : `${ing.cost} зм`;
      info.innerHTML = `<strong>${escapeHtml(ing.name)}</strong>
        <div class="small muted">${RARITY[ing.rarity].name} • ${costTxt}</div>`;
      row.appendChild(info);

      rec_match_area.appendChild(row);
    }
  } else {
    const selected = new Set(existing?.matchEffects ?? []);
    const hint = document.createElement("div");
    hint.className = "small muted";
    hint.style.marginBottom = "6px";
    hint.textContent = "Выбери эффекты: рецепт сработает, если эти тэги присутствуют среди эффектов выбранных ингредиентов.";
    rec_match_area.appendChild(hint);

    const row = document.createElement("div");
    row.className = "row";
    for (const key of Object.keys(EFFECTS)) {
      const lab = document.createElement("label");
      lab.className = "pill";
      lab.style.cursor = "pointer";
      const cb = document.createElement("input");
      cb.type = "checkbox";
      cb.checked = selected.has(key);
      cb.dataset.key = key;
      cb.style.marginRight = "6px";
      lab.prepend(cb);
      lab.append(document.createTextNode(EFFECTS[key].name));
      row.appendChild(lab);
    }
    rec_match_area.appendChild(row);
  }
}

rec_save.onclick = () => {
  const id = rec_id.value.trim();
  const name = rec_name.value.trim();
  if (!id || !/^[a-z0-9_\-]+$/i.test(id)) return alert("id рецепта обязателен (латиница/цифры/ _ -).");
  if (!name) return alert("Название результата обязательно.");

  const kind = rec_kind.value;
  const power = Number(rec_power.value);
  const baseDcRaw = rec_base_dc.value.trim();
  const baseDc = baseDcRaw === "" ? null : Number(baseDcRaw);
  if (baseDc !== null && (!Number.isFinite(baseDc) || baseDc < 0)) return alert("baseDc должен быть числом >= 0 или пустым.");

  const imageFile = rec_image_file.value.trim() || null;

  let matchIngredients = null;
  let matchEffects = null;

  if (kind === "ingredients") {
    matchIngredients = [...rec_match_area.querySelectorAll("input[type=checkbox]")]
      .filter(cb => cb.checked)
      .map(cb => cb.dataset.id);
    if (matchIngredients.length < 2 || matchIngredients.length > 3) return alert("Для точного рецепта выбери 2–3 ингредиента.");
  } else {
    matchEffects = [...rec_match_area.querySelectorAll("input[type=checkbox]")]
      .filter(cb => cb.checked)
      .map(cb => cb.dataset.key);
    if (matchEffects.length < 1) return alert("Для рецепта по эффектам выбери хотя бы 1 эффект.");
  }

  const obj = {
    id, kind, name,
    desc: rec_desc.value.trim(),
    power,
    baseDc,
    matchIngredients,
    matchEffects,
    imageFile
  };

  const exists = state.store.recipes.some(r => r.id === id);
  state.store.recipes = exists
    ? state.store.recipes.map(r => r.id === id ? obj : r)
    : [...state.store.recipes, obj];

  saveStore();
  renderAll();
  recipeDialog.close();
};

rec_delete.onclick = () => {
  const id = state.editingRecipeId;
  if (!id) return;
  if (!confirm("Удалить рецепт?")) return;
  state.store.recipes = state.store.recipes.filter(r => r.id !== id);
  saveStore();
  renderAll();
  recipeDialog.close();
};

/* ========= Rendering ========= */
function renderAll(){
  renderIngredients();
  renderRecipes();
  renderZone(document.getElementById("bagZone"), elBagItems, state.bag, "bag");
  renderZone(document.getElementById("retortZone"), elRetortItems, state.retort, "retort");
}

function renderIngredients(){
  const q = elSearch.value.trim().toLowerCase();
  const rf = elRarityFilter.value;

  const items = state.store.ingredients.filter(i => {
    if (rf && i.rarity !== rf) return false;
    if (!q) return true;
    const effectsText = (i.effects || []).map(e => EFFECTS[e]?.name ?? e).join(" ").toLowerCase();
    const descText = (i.desc || "").toLowerCase();
    return (
      i.name.toLowerCase().includes(q) ||
      i.id.toLowerCase().includes(q) ||
      effectsText.includes(q) ||
      descText.includes(q)
    );
  });

  elIngredients.innerHTML = "";
  for (const ing of items) {
    const card = document.createElement("div");
    card.className = "card";
    card.draggable = true;
    card.dataset.id = ing.id;
    card.ondragstart = (ev) => ev.dataTransfer.setData("text/plain", ing.id);

    const top = document.createElement("div");
    top.className = "top";

    const left = document.createElement("div");
    left.style.display = "flex";
    left.style.gap = "10px";
    left.style.alignItems = "center";

    const url = imgUrlOf(ing.imageFile);
    if (url) {
      const img = document.createElement("img");
      img.className = "img";
      img.alt = ing.name;
      img.src = url;
      left.appendChild(img);
    }

    const title = document.createElement("div");
    const costTxt = (ing.cost === null || ing.cost === undefined || ing.cost === "") ? "—" : `${ing.cost} зм`;
    title.innerHTML = `<div><strong>${escapeHtml(ing.name)}</strong> <span class="small muted">(${escapeHtml(ing.id)})</span></div>
      <div class="small muted">${costTxt} • ${RARITY[ing.rarity].name}</div>`;
    left.appendChild(title);

    const right = document.createElement("div");
    right.style.display = "flex";
    right.style.gap = "8px";
    right.style.alignItems = "center";
    right.innerHTML = `<div class="tag">${RARITY[ing.rarity].name}</div>`;

    top.appendChild(left);
    top.appendChild(right);

    const desc = document.createElement("div");
    desc.className = "small muted";
    desc.style.marginTop = "8px";
    desc.textContent = ing.desc ? ing.desc : "";

    const pills = document.createElement("div");
    pills.className = "pillbar";
    for (const e of ing.effects || []) {
      const pill = document.createElement("div");
      pill.className = "pill";
      pill.textContent = EFFECTS[e]?.name ?? e;
      pills.appendChild(pill);
    }

    const actions = document.createElement("div");
    actions.className = "row";
    actions.style.marginTop = "8px";

    const add = document.createElement("button");
    add.type = "button";
    add.textContent = "В мешочек";
    add.onclick = () => addToBag(ing.id);

    const quick = document.createElement("button");
    quick.type = "button";
    quick.textContent = "В реторту";
    quick.onclick = () => addToRetort(ing.id);

    const edit = document.createElement("button");
    edit.type = "button";
    edit.textContent = "Редактировать";
    edit.onclick = () => openIngredientEditor(ing.id);

    actions.appendChild(add);
    actions.appendChild(quick);
    actions.appendChild(edit);

    card.appendChild(top);
    if (ing.desc) card.appendChild(desc);
    card.appendChild(pills);
    card.appendChild(actions);

    elIngredients.appendChild(card);
  }
}

function renderRecipes(){
  elRecipes.innerHTML = "";
  const recipes = [...state.store.recipes].sort((a,b) => (a.kind === b.kind ? 0 : (a.kind === "ingredients" ? -1 : 1)));
  for (const r of recipes) {
    const card = document.createElement("div");
    card.className = "card";

    const top = document.createElement("div");
    top.className = "top";

    const left = document.createElement("div");
    left.style.display = "flex";
    left.style.gap = "10px";
    left.style.alignItems = "center";

    const url = imgUrlOf(r.imageFile);
    if (url) {
      const img = document.createElement("img");
      img.className = "img";
      img.alt = r.name;
      img.src = url;
      left.appendChild(img);
    }

    const title = document.createElement("div");
    title.innerHTML = `<div><strong>${escapeHtml(r.name)}</strong> <span class="small muted">(${escapeHtml(r.id)})</span></div>
      <div class="small muted">${r.kind === "ingredients" ? "Точный рецепт по ингредиентам" : "Рецепт по эффектам"}</div>`;
    left.appendChild(title);

    const right = document.createElement("div");
    right.innerHTML = `<div class="tag">Сила: ${["малая","средняя","сильная"][r.power ?? 1]}</div>`;
    top.appendChild(left);
    top.appendChild(right);

    const cond = document.createElement("div");
    cond.className = "small muted";
    cond.style.marginTop = "8px";
    cond.innerHTML = r.kind === "ingredients"
      ? `<strong>Ингредиенты:</strong> ${(r.matchIngredients||[]).map(id => escapeHtml(ingredientName(id))).join(", ")}`
      : `<strong>Эффекты:</strong> ${(r.matchEffects||[]).map(e => escapeHtml(EFFECTS[e]?.name ?? e)).join(", ")}`;

    const actions = document.createElement("div");
    actions.className = "row";
    actions.style.marginTop = "8px";

    const edit = document.createElement("button");
    edit.type = "button";
    edit.textContent = "Редактировать";
    edit.onclick = () => openRecipeEditor(r.id);

    const test = document.createElement("button");
    test.type = "button";
    test.textContent = "Загрузить в реторту";
    test.onclick = () => {
      if (r.kind !== "ingredients") return alert("Этот рецепт не по ингредиентам. Он срабатывает по эффектам.");
      state.retort = [...(r.matchIngredients||[])];
      saveLocal("retort", state.retort);
      renderAll();
      showResult(null);
    };

    actions.appendChild(edit);
    actions.appendChild(test);

    card.appendChild(top);
    card.appendChild(cond);
    card.appendChild(actions);
    elRecipes.appendChild(card);
  }
}

function renderZone(zoneEl, container, ids, zoneName){
  container.innerHTML = "";
  attachDropHandlers(zoneEl, zoneName);

  ids.forEach((id, idx) => {
    const ing = state.store.ingredients.find(x => x.id === id);
    if (!ing) return;

    const chip = document.createElement("span");
    chip.className = "item";

    const url = imgUrlOf(ing.imageFile);
    if (url) {
      const img = document.createElement("img");
      img.className = "img";
      img.src = url;
      img.alt = ing.name;
      chip.appendChild(img);
    }

    const text = document.createElement("span");
    text.textContent = ing.name;
    chip.appendChild(text);

    const rm = document.createElement("button");
    rm.textContent = "×";
    rm.title = "Убрать";
    rm.onclick = () => {
      if (zoneName === "bag") state.bag.splice(idx, 1);
      if (zoneName === "retort") state.retort.splice(idx, 1);
      saveLocal("bag", state.bag); saveLocal("retort", state.retort);
      renderAll();
    };

    const mv = document.createElement("button");
    mv.textContent = (zoneName === "bag") ? "→" : "←";
    mv.title = (zoneName === "bag") ? "В реторту" : "В мешочек";
    mv.onclick = () => {
      if (zoneName === "bag") {
        if (state.retort.length >= 3) return;
        const [m] = state.bag.splice(idx, 1);
        state.retort.push(m);
      } else {
        const [m] = state.retort.splice(idx, 1);
        state.bag.push(m);
      }
      saveLocal("bag", state.bag); saveLocal("retort", state.retort);
      renderAll();
    };

    chip.appendChild(mv);
    chip.appendChild(rm);
    container.appendChild(chip);
  });
}

function attachDropHandlers(zone, zoneName){
  zone.ondragover = (ev) => { ev.preventDefault(); zone.classList.add("dragover"); };
  zone.ondragleave = () => zone.classList.remove("dragover");
  zone.ondrop = (ev) => {
    ev.preventDefault();
    zone.classList.remove("dragover");
    const id = ev.dataTransfer.getData("text/plain");
    if (!id) return;
    if (zoneName === "bag") addToBag(id);
    if (zoneName === "retort") addToRetort(id);
  };
}

/* ========= Actions ========= */
function addToBag(id){
  if (!state.store.ingredients.some(x => x.id === id)) return;
  state.bag.push(id);
  saveLocal("bag", state.bag);
  renderAll();
}
function addToRetort(id){
  if (!state.store.ingredients.some(x => x.id === id)) return;
  if (state.retort.length >= 3) return;
  state.retort.push(id);
  saveLocal("retort", state.retort);
  renderAll();
}

/* ========= Brewing logic ========= */
function computeBrew(selectedIngredients, { labTier, maxEffects }) {
  const recipeHit = findRecipeHit(selectedIngredients);
  if (recipeHit) return brewFromRecipe(recipeHit, selectedIngredients, { labTier });

  const sets = selectedIngredients.map(i => new Set(i.effects || []));
  let intersection = new Set(sets[0]);
  for (let s of sets.slice(1)) intersection = new Set([...intersection].filter(x => s.has(x)));

  const commonEffects = [...intersection].filter(e => EFFECTS[e]);
  if (commonEffects.length === 0) {
    return { error: "Нет общего эффекта. Эти ингредиенты не дают зелье.", hint: "Поменяй один ингредиент на тот, где совпадает хотя бы один тэг." };
  }

  let chosen = [commonEffects[0]];
  if (maxEffects >= 2) {
    const freq = {};
    for (const ing of selectedIngredients) for (const e of (ing.effects || [])) freq[e] = (freq[e]||0)+1;
    const pairCommon = Object.keys(freq).filter(e => freq[e] >= 2 && EFFECTS[e]);
    const second = pairCommon.find(e => e !== chosen[0]);
    if (second) chosen.push(second);
  }

  const maxRarity = selectedIngredients.reduce((acc, ing) => {
    const order = ["common","uncommon","rare","very_rare"];
    return (order.indexOf(ing.rarity) > order.indexOf(acc)) ? ing.rarity : acc;
  }, "common");

  const base = 10;
  const power = Math.max(...chosen.map(e => EFFECTS[e].power));
  const powerDc = (power === 0) ? 0 : (power === 1) ? 2 : 4;
  const rarityDc = RARITY[maxRarity].dc;
  const multiDc = (chosen.length === 1) ? 0 : (chosen.length === 2) ? 2 : 4;

  let dc = base + powerDc + rarityDc + multiDc;

  let timeText = "";
  let dcMod = 0;
  let note = null;

  if (labTier === "t0") { timeText = "2 часа (внутри Длительного Отдыха)"; dcMod += 2; }
  if (labTier === "t1") { timeText = "1 час (внутри Длительного Отдыха)"; }
  if (labTier === "t2") { timeText = "20 минут (можно 3 варки за отдых)"; dcMod -= 1; note = "Ядро: учтено −1 к DC (вместо этого можно +1 к проверке)."; }

  dc = Math.max(8, dc + dcMod);

  return {
    potionName: chosen.map(e => EFFECTS[e].name).join(" + "),
    potionDesc: chosen.map(e => "• " + EFFECTS[e].desc).join("<br>"),
    potionImageFile: null,
    dc, timeText,
    rarity: RARITY[maxRarity].name,
    used: selectedIngredients.map(i => i.name),
    note
  };
}

function findRecipeHit(selectedIngredients){
  const ids = selectedIngredients.map(i => i.id).slice().sort().join("|");
  const exact = state.store.recipes.filter(r => r.kind === "ingredients");
  for (const r of exact) {
    const need = (r.matchIngredients || []).slice().sort().join("|");
    if (need && need === ids) return r;
  }
  const avail = new Set();
  for (const ing of selectedIngredients) for (const e of (ing.effects || [])) avail.add(e);
  const eff = state.store.recipes.filter(r => r.kind === "effects");
  for (const r of eff) {
    const req = r.matchEffects || [];
    if (req.length === 0) continue;
    if (req.every(e => avail.has(e))) return r;
  }
  return null;
}

function brewFromRecipe(recipe, selectedIngredients, { labTier }) {
  const maxRarity = selectedIngredients.reduce((acc, ing) => {
    const order = ["common","uncommon","rare","very_rare"];
    return (order.indexOf(ing.rarity) > order.indexOf(acc)) ? ing.rarity : acc;
  }, "common");

  let timeText = "";
  let dcMod = 0;
  let note = null;

  if (labTier === "t0") { timeText = "2 часа (внутри Длительного Отдыха)"; dcMod += 2; }
  if (labTier === "t1") { timeText = "1 час (внутри Длительного Отдыха)"; }
  if (labTier === "t2") { timeText = "20 минут (можно 3 варки за отдых)"; dcMod -= 1; note = "Ядро: учтено −1 к DC (вместо этого можно +1 к проверке)."; }

  let dc;
  if (recipe.baseDc !== null && recipe.baseDc !== undefined) {
    dc = Math.max(8, Number(recipe.baseDc) + dcMod);
  } else {
    const base = 10;
    const powerDc = (recipe.power === 0) ? 0 : (recipe.power === 1) ? 2 : 4;
    const rarityDc = RARITY[maxRarity].dc;
    dc = Math.max(8, base + powerDc + rarityDc + dcMod);
  }

  return {
    potionName: recipe.name,
    potionDesc: (recipe.desc || "").split("\n").map(line => escapeHtml(line)).join("<br>"),
    potionImageFile: recipe.imageFile || null,
    dc, timeText,
    rarity: RARITY[maxRarity].name,
    used: selectedIngredients.map(i => i.name),
    note: note ? (note + " Результат задан рецептом.") : "Результат задан рецептом."
  };
}

/* ========= Result render ========= */
function showResult(res){
  if (!res) { elResult.innerHTML = `<div class="muted">Добавь 2–3 ингредиента в реторту и нажми “Сварить”.</div>`; return; }
  if (res.error) {
    elResult.innerHTML = `<div><strong>Не получилось:</strong> ${escapeHtml(res.error)}</div>${res.hint ? `<div class="muted" style="margin-top:6px">${escapeHtml(res.hint)}</div>` : ""}`;
    return;
  }

  const imgUrl = imgUrlOf(res.potionImageFile);
  const imgHtml = imgUrl ? `<img class="imgBig" src="${imgUrl}" alt="result" style="margin-bottom:10px">` : "";

  elResult.innerHTML = `
    ${imgHtml}
    <div><strong>Результат:</strong> ${escapeHtml(res.potionName)}</div>
    <div class="muted" style="margin-top:6px"><strong>Ингредиенты:</strong> ${escapeHtml(res.used.join(", "))}</div>
    <div style="margin-top:10px">${res.potionDesc}</div>
    <hr style="border:0;border-top:1px solid #2b2e3a;margin:12px 0">
    <div><strong>DC приготовления:</strong> ${res.dc}</div>
    <div><strong>Время:</strong> ${escapeHtml(res.timeText)}</div>
    <div><strong>Редкость по компонентам:</strong> ${escapeHtml(res.rarity)}</div>
    ${res.note ? `<div class="muted" style="margin-top:8px">${escapeHtml(res.note)}</div>` : ""}
  `;
}

/* ========= Utils ========= */
function imgUrlOf(imageFile){
  const f = (imageFile || "").trim();
  if (!f) return null;
  return IMG_BASE + f;
}
function updatePreview(imgEl, imageFile){
  const url = imgUrlOf(imageFile);
  if (!url) { imgEl.style.display = "none"; imgEl.src = ""; return; }
  imgEl.style.display = "block";
  imgEl.src = url;
}
function ingredientName(id){
  return state.store.ingredients.find(i => i.id === id)?.name ?? id;
}
function escapeHtml(s){
  return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;");
}
</script>
</body>
</html>
